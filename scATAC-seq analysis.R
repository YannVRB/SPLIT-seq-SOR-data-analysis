#This script assumes you already ran cellranger-atac pipelien from 10x genomics.

#Loading librairies.
library(Signac)
library(Seurat)
library(GenomeInfoDb)
library(EnsDb.Mmusculus.v79)
library(ggplot2)

#Creating a Seurat object using the peak/cell matrix and cell metadata generated by cellranger-atac, and store the path to the fragment file on disk in the Seurat object.
counts_HC1 <- Read10X_h5(filename = "HC1-filtered_peak_bc_matrix.h5")
metadata_HC1 <- read.csv(
  file = "HC1-singlecell.csv",
  header = TRUE,
  row.names = 1
)

counts_HC2 <- Read10X_h5(filename = "HC2-filtered_peak_bc_matrix.h5")
metadata_HC2 <- read.csv(
  file = "HC2-singlecell.csv",
  header = TRUE,
  row.names = 1
)

counts_HC7 <- Read10X_h5(filename = "HC7-filtered_peak_bc_matrix.h5")
metadata_HC7 <- read.csv(
  file = "HC7-singlecell.csv",
  header = TRUE,
  row.names = 1
)

counts_HC8 <- Read10X_h5(filename = "HC8-filtered_peak_bc_matrix.h5")
metadata_HC8 <- read.csv(
  file = "HC8-singlecell.csv",
  header = TRUE,
  row.names = 1
)

counts_SOR1 <- Read10X_h5(filename = "SOR1-filtered_peak_bc_matrix.h5")
metadata_SOR1 <- read.csv(
  file = "SOR1-singlecell.csv",
  header = TRUE,
  row.names = 1
)

counts_SOR2 <- Read10X_h5(filename = "SOR2-filtered_peak_bc_matrix.h5")
metadata_SOR2 <- read.csv(
  file = "SOR2-singlecell.csv",
  header = TRUE,
  row.names = 1
)

counts_SOR7 <- Read10X_h5(filename = "SOR7-filtered_peak_bc_matrix.h5")
metadata_SOR7 <- read.csv(
  file = "SOR7-singlecell.csv",
  header = TRUE,
  row.names = 1
)

counts_SOR8 <- Read10X_h5(filename = "SOR8-filtered_peak_bc_matrix.h5")
metadata_SOR8 <- read.csv(
  file = "SOR8-singlecell.csv",
  header = TRUE,
  row.names = 1
)

chrom_assay_HC1 <- CreateChromatinAssay(
  counts = counts_HC1,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'HC1-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

chrom_assay_HC2 <- CreateChromatinAssay(
  counts = counts_HC2,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'HC2-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

chrom_assay_HC7 <- CreateChromatinAssay(
  counts = counts_HC7,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'HC7-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

chrom_assay_HC8 <- CreateChromatinAssay(
  counts = counts_HC8,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'HC8-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

chrom_assay_SOR1 <- CreateChromatinAssay(
  counts = counts_SOR1,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'SOR1-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

chrom_assay_SOR2 <- CreateChromatinAssay(
  counts = counts_SOR2,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'SOR2-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

chrom_assay_SOR7 <- CreateChromatinAssay(
  counts = counts_SOR7,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'SOR7-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

chrom_assay_SOR8 <- CreateChromatinAssay(
  counts = counts_SOR8,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'SOR8-fragments.tsv.gz',
  min.cells = 10,
  min.features = 200
)

HC1_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_HC1,
  assay = "peaks",
  project = 'HC',
  meta.data = metadata_HC1
)

HC2_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_HC2,
  assay = "peaks",
  project = 'HC',
  meta.data = metadata_HC2
)

HC7_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_HC7,
  assay = "peaks",
  project = 'HC',
  meta.data = metadata_HC7
)

HC8_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_HC8,
  assay = "peaks",
  project = 'HC',
  meta.data = metadata_HC8
)

SOR1_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_SOR1,
  assay = "peaks",
  project = 'SOR',
  meta.data = metadata_SOR1
)

SOR2_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_SOR2,
  assay = "peaks",
  project = 'SOR',
  meta.data = metadata_SOR2
)

SOR7_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_SOR7,
  assay = "peaks",
  project = 'SOR',
  meta.data = metadata_SOR7
)

SOR8_seuratobject <- CreateSeuratObject(
  counts = chrom_assay_SOR8,
  assay = "peaks",
  project = 'SOR',
  meta.data = metadata_SOR8
)

#Computing QC Metrics.
#Compute nucleosome signal score per cell.
HC1_seuratobject <- NucleosomeSignal(object = HC1_seuratobject)
HC2_seuratobject <- NucleosomeSignal(object = HC2_seuratobject)
HC7_seuratobject <- NucleosomeSignal(object = HC7_seuratobject)
HC8_seuratobject <- NucleosomeSignal(object = HC8_seuratobject)
SOR1_seuratobject <- NucleosomeSignal(object = SOR1_seuratobject)
SOR2_seuratobject <- NucleosomeSignal(object = SOR2_seuratobject)
SOR7_seuratobject <- NucleosomeSignal(object = SOR7_seuratobject)
SOR8_seuratobject <- NucleosomeSignal(object = SOR8_seuratobject)
#Compute TSS enrichment score per cell
HC1_seuratobject <- TSSEnrichment(object = HC1_seuratobject, fast = FALSE)
HC2_seuratobject <- TSSEnrichment(object = HC2_seuratobject, fast = FALSE)
HC7_seuratobject <- TSSEnrichment(object = HC7_seuratobject, fast = FALSE)
HC8_seuratobject <- TSSEnrichment(object = HC8_seuratobject, fast = FALSE)
SOR1_seuratobject <- TSSEnrichment(object = SOR1_seuratobject, fast = FALSE)
SOR2_seuratobject <- TSSEnrichment(object = SOR2_seuratobject, fast = FALSE)
SOR7_seuratobject <- TSSEnrichment(object = SOR7_seuratobject, fast = FALSE)
SOR8_seuratobject <- TSSEnrichment(object = SOR8_seuratobject, fast = FALSE)
#Add fraction of reads in peaks.
HC1_seuratobject$pct_reads_in_peaks <- HC1_seuratobject$peak_region_fragments / HC1_seuratobject$passed_filters * 100
HC2_seuratobject$pct_reads_in_peaks <- HC2_seuratobject$peak_region_fragments / HC2_seuratobject$passed_filters * 100
HC7_seuratobject$pct_reads_in_peaks <- HC7_seuratobject$peak_region_fragments / HC7_seuratobject$passed_filters * 100
HC8_seuratobject$pct_reads_in_peaks <- HC8_seuratobject$peak_region_fragments / HC8_seuratobject$passed_filters * 100
HC1_seuratobject$high.tss <- ifelse(HC1_seuratobject$TSS.enrichment > 2, 'High', 'Low')
HC2_seuratobject$high.tss <- ifelse(HC2_seuratobject$TSS.enrichment > 2, 'High', 'Low')
HC7_seuratobject$high.tss <- ifelse(HC7_seuratobject$TSS.enrichment > 2, 'High', 'Low')
HC8_seuratobject$high.tss <- ifelse(HC8_seuratobject$TSS.enrichment > 2, 'High', 'Low')
SOR1_seuratobject$pct_reads_in_peaks <- SOR1_seuratobject$peak_region_fragments / SOR1_seuratobject$passed_filters * 100
SOR2_seuratobject$pct_reads_in_peaks <- SOR2_seuratobject$peak_region_fragments / SOR2_seuratobject$passed_filters * 100
SOR7_seuratobject$pct_reads_in_peaks <- SOR7_seuratobject$peak_region_fragments / SOR7_seuratobject$passed_filters * 100
SOR8_seuratobject$pct_reads_in_peaks <- SOR8_seuratobject$peak_region_fragments / SOR8_seuratobject$passed_filters * 100
SOR1_seuratobject$high.tss <- ifelse(SOR1_seuratobject$TSS.enrichment > 2, 'High', 'Low')
SOR2_seuratobject$high.tss <- ifelse(SOR2_seuratobject$TSS.enrichment > 2, 'High', 'Low')
SOR7_seuratobject$high.tss <- ifelse(SOR7_seuratobject$TSS.enrichment > 2, 'High', 'Low')
SOR8_seuratobject$high.tss <- ifelse(SOR8_seuratobject$TSS.enrichment > 2, 'High', 'Low')
HC1_seuratobject$nucleosome_group <- ifelse(HC1_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
HC2_seuratobject$nucleosome_group <- ifelse(HC2_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
HC7_seuratobject$nucleosome_group <- ifelse(HC7_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
HC8_seuratobject$nucleosome_group <- ifelse(HC8_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
SOR1_seuratobject$nucleosome_group <- ifelse(SOR1_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
SOR2_seuratobject$nucleosome_group <- ifelse(SOR2_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
SOR7_seuratobject$nucleosome_group <- ifelse(SOR7_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
SOR8_seuratobject$nucleosome_group <- ifelse(SOR8_seuratobject$nucleosome_signal > 4, 'NS > 4', 'NS < 4')

#Remove cells that are outliers for these QC metrics.
HC1_seuratobject <- subset(
  x = HC1_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

HC2_seuratobject <- subset(
  x = HC2_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

HC7_seuratobject <- subset(
  x = HC7_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

HC8_seuratobject <- subset(
  x = HC8_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

SOR1_seuratobject <- subset(
  x = SOR1_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

SOR2_seuratobject <- subset(
  x = SOR2_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

SOR7_seuratobject <- subset(
  x = SOR7_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

SOR8_seuratobject <- subset(
  x = SOR8_seuratobject,
  subset = peak_region_fragments > 3000 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)


#Normalization and linear dimensional reduction.
HC1_seuratobject <- FindTopFeatures(HC1_seuratobject, min.cutoff = 10)
HC2_seuratobject <- FindTopFeatures(HC2_seuratobject, min.cutoff = 10)
HC7_seuratobject <- FindTopFeatures(HC7_seuratobject, min.cutoff = 10)
HC8_seuratobject <- FindTopFeatures(HC8_seuratobject, min.cutoff = 10)
HC1_seuratobject <- RunTFIDF(HC1_seuratobject)
HC2_seuratobject <- RunTFIDF(HC2_seuratobject)
HC7_seuratobject <- RunTFIDF(HC7_seuratobject)
HC8_seuratobject <- RunTFIDF(HC8_seuratobject)
HC1_seuratobject <- RunSVD(HC1_seuratobject)
HC2_seuratobject <- RunSVD(HC2_seuratobject)
HC7_seuratobject <- RunSVD(HC7_seuratobject)
HC8_seuratobject <- RunSVD(HC8_seuratobject)

SOR1_seuratobject <- FindTopFeatures(SOR1_seuratobject, min.cutoff = 10)
SOR2_seuratobject <- FindTopFeatures(SOR2_seuratobject, min.cutoff = 10)
SOR7_seuratobject <- FindTopFeatures(SOR7_seuratobject, min.cutoff = 10)
SOR8_seuratobject <- FindTopFeatures(SOR8_seuratobject, min.cutoff = 10)
SOR1_seuratobject <- RunTFIDF(SOR1_seuratobject)
SOR2_seuratobject <- RunTFIDF(SOR2_seuratobject)
SOR7_seuratobject <- RunTFIDF(SOR7_seuratobject)
SOR8_seuratobject <- RunTFIDF(SOR8_seuratobject)
SOR1_seuratobject <- RunSVD(SOR1_seuratobject)
SOR2_seuratobject <- RunSVD(SOR2_seuratobject)
SOR7_seuratobject <- RunSVD(SOR7_seuratobject)
SOR8_seuratobject <- RunSVD(SOR8_seuratobject)

#Non-linear dimension reduction and clustering.
HC1_seuratobject <- RunUMAP(
  object = HC1_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC2_seuratobject <- RunUMAP(
  object = HC2_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC7_seuratobject <- RunUMAP(
  object = HC7_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC8_seuratobject <- RunUMAP(
  object = HC8_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR1_seuratobject <- RunUMAP(
  object = SOR1_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR2_seuratobject <- RunUMAP(
  object = SOR2_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR7_seuratobject <- RunUMAP(
  object = SOR7_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR8_seuratobject <- RunUMAP(
  object = SOR8_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC1_seuratobject <- FindNeighbors(
  object = HC1_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC2_seuratobject <- FindNeighbors(
  object = HC2_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC7_seuratobject <- FindNeighbors(
  object = HC7_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC8_seuratobject <- FindNeighbors(
  object = HC8_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR1_seuratobject <- FindNeighbors(
  object = SOR1_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR2_seuratobject <- FindNeighbors(
  object = SOR2_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR7_seuratobject <- FindNeighbors(
  object = SOR7_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

SOR8_seuratobject <- FindNeighbors(
  object = SOR8_seuratobject,
  reduction = 'lsi',
  dims = 2:30
)

HC1_seuratobject <- FindClusters(
  object = HC1_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

HC2_seuratobject <- FindClusters(
  object = HC2_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

HC7_seuratobject <- FindClusters(
  object = HC7_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

HC8_seuratobject <- FindClusters(
  object = HC8_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

SOR1_seuratobject <- FindClusters(
  object = SOR1_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

SOR2_seuratobject <- FindClusters(
  object = SOR2_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

SOR7_seuratobject <- FindClusters(
  object = SOR7_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

SOR8_seuratobject <- FindClusters(
  object = SOR8_seuratobject,
  algorithm = 3,
  resolution = 1.2,
  verbose = FALSE
)

# Add dataset-identifying metadata for the two conditions homecage (HC) and Spatial Object Recognition (SOR).
HC1_seuratobject$dataset <- "HC"
HC2_seuratobject$dataset <- "HC"
HC7_seuratobject$dataset <- "HC"
HC8_seuratobject$dataset <- "HC"
SOR1_seuratobject$dataset <- "SOR"
SOR2_seuratobject$dataset <- "SOR"
SOR7_seuratobject$dataset <- "SOR"
SOR8_seuratobject$dataset <- "SOR"

#Merge
combined <- merge(
  x = HC1_seuratobject,
  y = list(HC2_seuratobject, HC7_seuratobject, HC8_seuratobject, SOR1_seuratobject, SOR2_seuratobject, SOR7_seuratobject, SOR8_seuratobject),
  add.cell.ids = c("HC1", "HC2", "HC7", "HC8", "SOR1", "SOR2", "SOR7", "SOR8")
)
#Process the combined dataset
combined <- FindTopFeatures(combined, min.cutoff = 10)
combined <- RunTFIDF(combined)
combined <- RunSVD(combined)
combined <- RunUMAP(combined, reduction = "lsi", dims = 2:30)
#Check if all clusters overlap in the 2D UMAP space. If there are no individual cluster of cells that present in one condition and not the other then skip the integration step.
DimPlot(combined, group.by = "dataset")

#Create a gene activity matrix 2000bp before and after the transcription start site of each gene.
gene.activities <- GeneActivity(combined, extend.upstream = 2000, extend.downstream = 2000)
#Add the gene activity matrix to the Seurat object as a new assay
combined[['RNA']] <- CreateAssayObject(counts = gene.activities)
#LogNormalize the new assay
combined <- NormalizeData(
  object = combined,
  assay = 'RNA',
  normalization.method = 'LogNormalize',
  scale.factor = median(combined$nCount_RNA)
)

#Annotating cell types
#Switch to the gene activity matrix previously computed.
DefaultAssay(combined) <- 'RNA'

#Transfer labels of previously identified cell types from HC samples of the SPLIT-seq data.
#Load the pre-processed scRNA-seq data.
seur_objSPLITseq <- readRDS("seur_obj.rds")
#Identify the indices of the cells corresponding to the "HC" category using the which() function.
hc_indices <- which(seur_obj$sample_category == "HC")
#Create a new Seurat object containing only the "HC" cells using the subset() function.
hc_seur_obj <- subset(seur_obj, cells = hc_indices)

#Transfer cell type labels from reference to query
transfer.anchors <- FindTransferAnchors(
  reference = hc_seur_obj,
  query = combined,
  reduction = 'cca',
  dims = 1:40
)

predicted.labelsHC <- TransferData(
  anchorset = transfer.anchors,
  refdata = hc_seur_obj@active.ident,
  weight.reduction = combined[['lsi']],
  dims = 2:30
)

combined <- AddMetaData(object = combined, metadata = predicted.labelsHC)

#Replace each label with its most likely prediction
for(i in levels(combined)) {
  cells_to_reid <- WhichCells(combined, idents = i)
  newid <- names(sort(table(combined$predicted.id[cells_to_reid]),decreasing=TRUE))[1]
  Idents(combined, cells = cells_to_reid) <- newid
}

#Visualize clusters identification
DimPlot(combined, label = TRUE, repel = TRUE) + NoLegend()

#Adding gene annotations to the seurat object for the mouse genome. This will allow downstream functions to pull the gene annotation information directly from the object.
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)
seqlevelsStyle(annotations) <- 'UCSC'
genome(annotations) <- "mm10"
Annotation(combined) <- annotations

#Find differentially accessible promoter between condition for a specific cell type.
#Change back to working with peaks instead of gene activities.
DefaultAssay(combined) <- 'peaks'
#Formatting labels for differential analysis.
combined$celltype.dataset <- paste(Idents(combined), combined$dataset, sep = "_")
combined$celltype <- Idents(combined)
Idents(combined) <- "celltype.dataset"
#Perform the differential analysis in Oligodendrocytes. Make sure to be in the RNA assay.
da_peaks_oligo <- FindMarkers(
  object = combined,
  ident.1 = "Oligodendrocytes_SOR",
  ident.2 = "Oligodendrocytes_HC",
  test.use = 'LR',
  latent.vars = 'nCount_peaks'
)

#Example coverage plot for the gene Sgk1 with a zoom around its promoter region. Make sure to be in the peaks assay.
sgk1CoveragePlot <- CoveragePlot(
  object = combined,
  region = c("Sgk1"),
  extend.upstream = 2000,
  extend.downstream = -113000)
